################################################################################
# This is template for appveyor.yml
# Before using it in your repository, modify places marked with # TODO Modify
################################################################################

#---------------------------------# 
#      environment configuration  # 
#---------------------------------# 
version: 1.0.{build}.0 # TODO Modify version

image: Visual Studio 2017
init:
#init script to download binaries required for integration testing
- ps: >-
    $LanguagePackFolderLocation = "c:\LanguagePacks\"

    $LanguagePackFileLocation = "c:\LanguagePacks\x64fre_Server_de-de_lp.cab"

    $StorageAccountName = "languageddsctesting"

    $ContainerName = "intergrationtesting"


    New-Item -Path $LanguagePackFolderLocation -ItemType Directory

    $RESTResult = Invoke-RestMethod "https://$StorageAccountName.blob.core.windows.net/$($ContainerName)?restype=container&comp=list" -Method Get

    [XML]$RESTResult = $RESTResult.Substring(3) #trim random chars off front

    [XML]$XMLResult = $RESTResult

    $reader=(New-Object System.Xml.XmlNodeReader $RESTResult)


    foreach ($Blob in $XMLResult.EnumerationResults.Blobs.GetEnumerator())

    {
        $OutputFile = Join-Path -Path $LanguagePackFolderLocation -ChildPath $Blob.Name
        (New-Object System.Net.WebClient).DownloadFile($Blob.Url, $OutputFile)
    }


install:
    - git clone https://github.com/PowerShell/DscResource.Tests
    - ps: Import-Module "$env:APPVEYOR_BUILD_FOLDER\DscResource.Tests\AppVeyor.psm1"
    - ps: Invoke-AppveyorInstallTask

#---------------------------------# 
#      build configuration        # 
#---------------------------------# 

build: false

#---------------------------------# 
#      test configuration         # 
#---------------------------------# 

test_script:
    - ps: |
        Invoke-AppveyorTestScriptTask -CodeCoverage -CodeCovIo -ExcludeTag "RebootRequired" -Verbose
        #Invoke-AppveyorTestScriptTask -CodeCoverage -CodeCovIo -ExcludeTag "Integration" -Verbose
    
#---------------------------------# 
#      deployment configuration   # 
#---------------------------------# 

# scripts to run before deployment 
deploy_script:
    - cmd: >-
        7z a LanguageDsc.zip %APPVEYOR_BUILD_FOLDER%\DSCResources\*
        7z a LanguageDsc.zip %APPVEYOR_BUILD_FOLDER%\Examples\*
        7z a LanguageDsc.zip %APPVEYOR_BUILD_FOLDER%\LanguageDsc.psd1
        7z a LanguageDsc.zip %APPVEYOR_BUILD_FOLDER%\LICENSE
        7z a LanguageDsc.zip %APPVEYOR_BUILD_FOLDER%\README.md
    - ps: |
        Invoke-AppveyorAfterTestTask


#---------------------------------# 
#      artifact configuration     # 
#---------------------------------# 

artifacts:
- path: LanguageDsc.zip
  name: LanguageDsc
